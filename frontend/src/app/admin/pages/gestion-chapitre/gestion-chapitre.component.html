<!-- Fichier : gestion-chapitre.component.html -->

<div class="container mt-4">
  
  <!-- ==================================================== -->
  <!-- 1. FORMULAIRE DE SÉLECTION (POUR CHARGER LE CHAPITRE) -->
  <!-- ==================================================== -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h3>Gestion des Chapitres</h3>
    </div>
    <div class="card-body">
      <p class="card-text">Sélectionnez une matière et un niveau pour charger la structure du chapitre correspondant.</p>
      
      <div class="row g-3 align-items-end">
        <!-- Liste déroulante pour les matières -->
        <div class="col-md-5">
          <label for="matiere" class="form-label">Matière</label>
          <select id="matiere" class="form-select" [(ngModel)]="selectedMatiereNom">
            <option [ngValue]="''" disabled>-- Choisissez une matière --</option>
            <!-- On utilise le pipe 'async' pour afficher les données de l'Observable matieres$ -->
            <option *ngFor="let matiere of matieres$ | async" [value]="matiere.nom">
              {{ matiere.nom }}
            </option>
          </select>
        </div>

        <!-- Liste déroulante pour les niveaux -->
        <div class="col-md-5">
          <label for="niveau" class="form-label">Niveau</label>
          <select id="niveau" class="form-select" [(ngModel)]="selectedNiveau">
            <option [ngValue]="null" disabled>-- Choisissez un niveau --</option>
            <option *ngFor="let n of niveaux" [value]="n">
              Niveau {{ n }}
            </option>
          </select>
        </div>

        <!-- Bouton pour charger la structure -->
        <div class="col-md-2">
          <button class="btn btn-primary w-100" (click)="chargerStructure()" [disabled]="!selectedMatiereNom || selectedNiveau === null">
            <span *ngIf="!isLoading">Charger</span>
            <!-- Indicateur de chargement -->
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================================================== -->
  <!-- 2. AFFICHAGE DU CHAPITRE ET DES SECTIONS (AVEC L'ÉDITEUR) -->
  <!-- ==================================================== -->
  
  <!-- On n'affiche cette partie que si un chapitre est chargé -->
  <div *ngIf="chapitreCharge">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Chapitre : {{ chapitreCharge.nom }}</h2>
      <!-- Bouton pour tout enregistrer -->
      <button class="btn btn-success" (click)="enregistrerChapitreComplet()">
        <i class="fas fa-save me-2"></i>Sauvegarder tout le chapitre
      </button>
    </div>

    <!-- Message si le chapitre n'a pas de sections -->
    <div *ngIf="chapitreCharge.sections.length === 0" class="alert alert-info">
      Ce chapitre ne contient aucune section pour le moment.
    </div>

    <!-- Boucle sur chaque section pour afficher un éditeur -->
    <div *ngFor="let section of chapitreCharge.sections; let i = index" class="card mb-3">
      <div class="card-header">
        <h4>Section {{ i + 1 }}: {{ section.titre }}</h4>
      </div>
      <div class="card-body">
        <!-- L'ÉDITEUR DE TEXTE ANGULAR EDITOR -->
        <angular-editor 
          [placeholder]="'Saisissez le contenu de la section ici...'" 
          [(ngModel)]="section.contenu"
          [config]="editorConfig">
        </angular-editor>

        <!-- Zone pour l'upload de fichiers (logique à implémenter) -->
        <div class="mt-3">
          <label for="file-upload-{{section.id}}" class="form-label">Ajouter un fichier (PDF, image...)</label>
          <input id="file-upload-{{section.id}}" type="file" class="form-control" (change)="onFileSelected($event, section.id)">
        </div>
      </div>
    </div>
  </div>

</div>

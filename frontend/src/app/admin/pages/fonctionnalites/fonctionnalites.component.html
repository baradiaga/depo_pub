<div class="admin-container">
  <h1 class="main-title">Administration des Fonctionnalités</h1>

  <!-- Onglets pour basculer entre les vues -->
  <div class="view-tabs">
    <button [class.active]="currentView === 'gestion'" (click)="currentView = 'gestion'">Gestion des Fonctionnalités (CRUD)</button>
    <button [class.active]="currentView === 'permissions'" (click)="currentView = 'permissions'">Gestion des Permissions par Rôle</button>
  </div>

  <!-- ===================================================== -->
  <!-- VUE 1: GESTION DES FONCTIONNALITÉS (CRUD) -->
  <!-- ===================================================== -->
  <div *ngIf="currentView === 'gestion'">
    <div *ngIf="!isFormVisible">
      <button class="btn primary add-btn" (click)="startNewFonctionnalite()">+ Ajouter une fonctionnalité</button>
      
      <div class="fonctionnalite-list">
        <div *ngFor="let f of allFonctionnalites" class="fonctionnalite-card">
          <div class="card-header">
            <h3><i class="icon">{{ f.icon }}</i> {{ f.nom }}</h3>
            <div class="actions">
              <button class="btn small" (click)="startEditFonctionnalite(f)">Modifier</button>
              <button class="btn small danger" (click)="deleteFonctionnalite(f.id)">Supprimer</button>
            </div>
          </div>
          <div class="card-body">
            <strong>Feature Key:</strong> {{ f.featureKey }}
            <ul>
              <li *ngFor="let sf of f.sousFonctionnalites">
                {{ sf.label }} ({{ sf.featureKey }}) -> {{ sf.route }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Formulaire de CRUD -->
    <div *ngIf="isFormVisible && editingFonctionnalite" class="form-container">
      <h2>{{ editingFonctionnalite.id ? 'Modifier la' : 'Nouvelle' }} fonctionnalité</h2>
      
      <div class="form-grid">
        <input [(ngModel)]="editingFonctionnalite.nom" placeholder="Nom (ex: Gestion des utilisateurs)">
        <input [(ngModel)]="editingFonctionnalite.featureKey" placeholder="Feature Key (ex: gestion_utilisateurs)">
        <input [(ngModel)]="editingFonctionnalite.icon" placeholder="Icône (ex: users)">
      </div>

      <h3>Sous-fonctionnalités</h3>
      <div *ngFor="let sf of editingFonctionnalite.sousFonctionnalites; let i = index" class="sub-feature-form">
        <input [(ngModel)]="sf.label" placeholder="Label (ex: Créer utilisateur)">
        <input [(ngModel)]="sf.featureKey" placeholder="Feature Key (ex: creer_utilisateur)">
        <input [(ngModel)]="sf.route" placeholder="Route (ex: /app/admin/users/create)">
        <button class="btn small danger" (click)="removeSubFeature(i)">X</button>
      </div>
      <button class="btn secondary" (click)="addSubFeature()">+ Ajouter une sous-fonctionnalité</button>

      <div class="form-actions">
        <button class="btn primary" (click)="saveFonctionnalite()">Enregistrer</button>
        <button class="btn" (click)="closeForm()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- VUE 2: GESTION DES PERMISSIONS -->
  <!-- ===================================================== -->
  <div *ngIf="currentView === 'permissions'">
    <div class="role-selector">
      <label>Sélectionner un rôle :</label>
<select (change)="onRoleChange($event)">        <option value="">-- Choisissez un rôle --</option>
        <option *ngFor="let role of roles" [value]="role">{{ role }}</option>
      </select>
    </div>

    <div *ngIf="selectedRole" class="permissions-grid">
      <div *ngFor="let f of allFonctionnalites" class="permission-group">
        <h4><input type="checkbox" [checked]="isFeatureChecked(f.featureKey)" (change)="toggleFeaturePermission(f.featureKey)"> {{ f.nom }}</h4>
        <ul>
          <li *ngFor="let sf of f.sousFonctionnalites">
            <input type="checkbox" [checked]="isFeatureChecked(sf.featureKey)" (change)="toggleFeaturePermission(sf.featureKey)"> {{ sf.label }}
          </li>
        </ul>
      </div>
      <div class="form-actions">
        <button class="btn primary" (click)="savePermissions()">Enregistrer les permissions pour {{ selectedRole }}</button>
      </div>
    </div>
  </div>
</div>

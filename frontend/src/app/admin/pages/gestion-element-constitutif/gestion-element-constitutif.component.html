<div class="container-fluid py-4">
  <h1 class="h3 mb-2 text-gray-800">Gestion des Matières (Éléments Constitutifs)</h1>
  <p class="mb-4">Cette page vous permet de gérer les matières de votre curriculum et de les assigner à des enseignants.</p>

  <!-- Section de sélection de l'UE et bouton d'ajout -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <label for="unite" class="form-label">Filtrer par Unité d'Enseignement (pour la création)</label>
        <select id="unite" class="form-select" (change)="onSelectUnite($any($event.target).value)">
          <option [value]="null">-- Toutes les Unités --</option>
          <option *ngFor="let ue of unites$ | async" [value]="ue.id">{{ ue.nom }}</option>
        </select>
      </div>
      <button class="btn btn-primary align-self-end" (click)="showNewForm()">
        <i class="fas fa-plus me-1"></i> Ajouter une Matière
      </button>
    </div>
  </div>

  <!-- Formulaire de création/modification -->
  <div *ngIf="isFormVisible" class="card shadow-sm mb-4">
    <div class="card-header">
      <h5 class="m-0">{{ isEditing ? 'Modifier la matière' : 'Ajouter une nouvelle matière' }}</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="elementForm" (ngSubmit)="onSubmit()">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="nom" class="form-label">Nom de la matière</label>
            <input type="text" id="nom" class="form-control" formControlName="nom">
          </div>
          <div class="col-md-6 mb-3">
            <label for="code" class="form-label">Code</label>
            <input type="text" id="code" class="form-control" formControlName="code">
          </div>
        </div>

        <div class="row">
          <div class="col-md-3 mb-3">
            <label for="credit" class="form-label">Coefficients</label>
            <input type="number" id="credit" class="form-control" formControlName="credit">
          </div>
          <div class="col-md-3 mb-3">
            <label for="volumeCours" class="form-label">Volume horaire Cours (h)</label>
            <input type="number" id="volumeCours" class="form-control" formControlName="volumeHoraireCours" min="0">
          </div>
          <div class="col-md-3 mb-3">
            <label for="volumeTD" class="form-label">Volume horaire TD (h)</label>
            <input type="number" id="volumeTD" class="form-control" formControlName="volumeHoraireTD" min="0">
          </div>
          <div class="col-md-3 mb-3">
            <label for="volumeTP" class="form-label">Volume horaire TP (h)</label>
            <input type="number" id="volumeTP" class="form-control" formControlName="volumeHoraireTP" min="0">
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="enseignant" class="form-label">Enseignant Responsable</label>
            <select id="enseignant" class="form-select" formControlName="enseignantId">
              <option [ngValue]="null">-- Aucun enseignant --</option>
              <option *ngFor="let enseignant of enseignants$ | async" [value]="enseignant.id">
                {{ enseignant.prenom }} {{ enseignant.nom }}
              </option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea id="description" class="form-control" formControlName="description" rows="3"></textarea>
        </div>

        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-secondary me-2" (click)="onCancel()">Annuler</button>
          <button type="submit" class="btn btn-success" [disabled]="elementForm.invalid">
            {{ isEditing ? 'Enregistrer les modifications' : 'Créer la matière' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tableau listant les matières -->
  <div class="card shadow-sm">
    <div class="card-header">
      <h5 class="m-0">Liste des Matières Existantes</h5>
    </div>
    <div class="card-body">
      <div *ngIf="isLoadingElements" class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
      </div>
      <div *ngIf="!isLoadingElements" class="table-responsive">
        <table class="table table-bordered table-hover" width="100%" cellspacing="0">
          <thead>
            <tr>
              <th>Code</th>
              <th>Nom</th>
              <th>Coefficients</th>
              <th>Volume Cours</th>
              <th>Volume TD</th>
              <th>Volume TP</th>
              <th>Total (h)</th>
              <th>Enseignant</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let element of elements">
              <td>{{ element.code }}</td>
              <td>{{ element.nom }}</td>
              <td>{{ element.credit }}</td>
              <td>{{ element.volumeHoraireCours }}</td>
              <td>{{ element.volumeHoraireTD }}</td>
              <td>{{ element.volumeHoraireTP }}</td>
              <td>{{ (element.volumeHoraireCours || 0) + (element.volumeHoraireTD || 0) + (element.volumeHoraireTP || 0) }}</td>
              <td>{{ element.enseignant ? element.enseignant.prenom + ' ' + element.enseignant.nom : 'Non assigné' }}</td>
              <td>
                <button class="btn btn-secondary btn-sm me-2" (click)="showEditForm(element)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" (click)="onDelete(element.id)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="elements.length === 0">
              <td colspan="9" class="text-center">Aucune matière trouvée.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

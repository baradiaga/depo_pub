<!-- Fichier : liste-matieres.component.html (Version Corrig√©e) -->

<div class="container mt-4">
  <h3 class="mb-4 text-primary text-center">Liste des Mati√®res et Chapitres</h3>

  <div *ngIf="isLoading" class="text-center">Chargement...</div>

  <ng-container *ngIf="!isLoading">
    <!-- S√©lecteur de mati√®re -->
    <div class="mb-3 text-center">
      <label for="matiereSelect" class="form-label fw-bold">S√©lectionner une mati√®re :</label>   

      <select id="matiereSelect" class="form-select w-auto d-inline-block"
              [(ngModel)]="matiereSelectionnee">
        <option value="" disabled selected>-- Choisir --</option>
        <!-- On appelle la m√©thode getMatieres() du composant -->
        <option *ngFor="let matiere of getMatieres()" [value]="matiere">
          {{ matiere }}
        </option>
      </select>
    </div>

    <!-- Tableau des chapitres -->
    <table class="table table-bordered table-striped align-middle text-center" *ngIf="matiereSelectionnee">
      <thead class="table-dark">
        <tr>
          <th>Mati√®re</th>
          <th>Chapitre</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- On v√©rifie que la mati√®re s√©lectionn√©e a bien des chapitres -->
        <ng-container *ngIf="chapitresParMatiere[matiereSelectionnee] && chapitresParMatiere[matiereSelectionnee].length > 0">
          <ng-container *ngFor="let chapitre of chapitresParMatiere[matiereSelectionnee]; let i = index">
            <tr>
              <!-- Mati√®re affich√©e une seule fois -->
              <td *ngIf="i === 0" [attr.rowspan]="chapitresParMatiere[matiereSelectionnee].length"
                  class="align-middle fw-bold">
                {{ matiereSelectionnee }}
              </td>

              <!-- Titre du chapitre -->
              <!-- Correction : utiliser 'chapitre.nom' au lieu de 'chapitre.titre' -->
              <td class="align-middle">{{ chapitre.nom }}</td>

              <!-- Bouton unique -->
              <td *ngIf="i === 0" [attr.rowspan]="chapitresParMatiere[matiereSelectionnee].length" class="align-middle">
                <button class="btn btn-sm btn-outline-primary" (click)="toggleContenu(matiereSelectionnee)">
                  {{ isContenuVisible(matiereSelectionnee) ? 'Masquer structure' : 'D√©tail structure' }}
                </button>
              </td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Cas o√π il n'y a aucun chapitre pour la mati√®re s√©lectionn√©e -->
        <tr *ngIf="!chapitresParMatiere[matiereSelectionnee] || chapitresParMatiere[matiereSelectionnee].length === 0">
          <td class="align-middle fw-bold">{{ matiereSelectionnee }}</td>
          <td colspan="2">Aucun chapitre trouv√© pour cette mati√®re.</td>
        </tr>

        <!-- Structure d√©taill√©e (s'affiche sous le tableau principal) -->
        <tr *ngIf="isContenuVisible(matiereSelectionnee)">
          <td colspan="3">
            <h5 class="structure-title">Structure compl√®te de {{ matiereSelectionnee }}</h5>
            
            <div *ngIf="!chapitresParMatiere[matiereSelectionnee] || chapitresParMatiere[matiereSelectionnee].length === 0">
              Pas de structure √† afficher.
            </div>

            <div class="chapitre-card" *ngFor="let chapitre of chapitresParMatiere[matiereSelectionnee]">
              <div class="chapitre-header">
                üìò Chapitre : <span class="chapitre-title">{{ chapitre.nom }}</span>
              </div>
              <!-- NOTE: La donn√©e 'sections' n'est pas charg√©e pour l'instant, donc cette partie sera vide -->
              <ul class="section-list">
                <li *ngFor="let section of getSectionsUniques(chapitre.sections)">
                  Section : <strong>{{ section.titre || section.name || section.label || 'Sans titre' }}</strong>
                </li>
                <li *ngIf="!chapitre.sections || chapitre.sections.length === 0">
                  (Aucune section pour ce chapitre)
                </li>
              </ul>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>
</div>

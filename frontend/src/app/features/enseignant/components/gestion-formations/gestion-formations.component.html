<div class="container">
  <h1>Gestion des Formations Académiques</h1>

  <!-- Affichage des totaux calculés -->
  <div class="alert alert-info" *ngIf="formationForm.valid">
    <p><strong>Volume Horaire Total Calculé :</strong> {{ volumeHoraireTotal }} heures</p>
    <p><strong>Total ECTS Calculé :</strong> {{ ectsTotal }} crédits</p>
  </div>

  <!-- Formulaire de Création/Modification -->
  <form [formGroup]="formationForm" (ngSubmit)="submitFormation()" class="form-card">
    <h2>{{ editingFormationId ? 'Modifier' : 'Créer' }} une Formation</h2>

    <!-- Nouvelle Section: Références administratives -->
    <fieldset class="form-section">
      <legend>Références administratives</legend>
      <div class="row">
        <div class="col-md-4 form-group">
          <label for="etablissement">Établissement *</label>
          <select id="etablissement" formControlName="etablissementId" class="form-control" required>
            <option value="">Sélectionner un établissement</option>
            <option *ngFor="let etablissement of etablissements" [value]="etablissement.id">
              {{ etablissement.nom }}
            </option>
          </select>
          <div *ngIf="formationForm.get('etablissementId')?.invalid && formationForm.get('etablissementId')?.touched" 
               class="text-danger">
            L'établissement est requis.
          </div>
          <div *ngIf="isLoadingEtablissements" class="text-muted small">
            Chargement des établissements...
          </div>
        </div>
        
        <div class="col-md-4 form-group">
          <label for="uefr">UFR *</label>
          <select id="uefr" formControlName="uefrId" class="form-control" required
                  [disabled]="!uefrs.length || isLoadingUefrs">
            <option value="">Sélectionner une UFR</option>
            <option *ngFor="let uefr of uefrs" [value]="uefr.id">
              {{ uefr.nom }}
            </option>
          </select>
          <div *ngIf="formationForm.get('uefrId')?.invalid && formationForm.get('uefrId')?.touched" 
               class="text-danger">
            L'UFR est requise.
          </div>
          <div *ngIf="isLoadingUefrs" class="text-muted small">
            Chargement des UFR...
          </div>
          <div *ngIf="!isLoadingUefrs && uefrs.length === 0 && formationForm.get('etablissementId')?.value" 
               class="text-warning small">
            Aucune UFR trouvée pour cet établissement.
          </div>
        </div>
        
        <div class="col-md-4 form-group">
          <label for="departement">Département *</label>
          <select id="departement" formControlName="departementId" class="form-control" required
                  [disabled]="!departements.length || isLoadingDepartements">
            <option value="">Sélectionner un département</option>
            <option *ngFor="let departement of departements" [value]="departement.id">
              {{ departement.nom }}
            </option>
          </select>
          <div *ngIf="formationForm.get('departementId')?.invalid && formationForm.get('departementId')?.touched" 
               class="text-danger">
            Le département est requis.
          </div>
          <div *ngIf="isLoadingDepartements" class="text-muted small">
            Chargement des départements...
          </div>
          <div *ngIf="!isLoadingDepartements && departements.length === 0 && formationForm.get('uefrId')?.value" 
               class="text-warning small">
            Aucun département trouvé pour cette UFR.
          </div>
        </div>
      </div>
    </fieldset>

    <!-- Section 1: Informations Générales -->
    <fieldset class="form-section">
      <legend>Informations Générales</legend>
      <div class="row">
        <div class="col-md-6 form-group">
          <label for="nom">Nom de la Formation *</label>
          <input id="nom" type="text" formControlName="nom" class="form-control" required>
          <div *ngIf="formationForm.get('nom')?.invalid && formationForm.get('nom')?.touched" class="text-danger">
            Le nom est requis (max 200 caractères).
          </div>
        </div>
        <div class="col-md-6 form-group">
          <label for="code">Code *</label>
          <input id="code" type="text" formControlName="code" class="form-control" required>
          <div *ngIf="formationForm.get('code')?.invalid && formationForm.get('code')?.touched" class="text-danger">
            Le code est requis (max 50 caractères).
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" formControlName="description" class="form-control" rows="3"></textarea>
      </div>

      <div class="row">
        <div class="col-md-4 form-group">
          <label for="statut">Statut *</label>
          <select id="statut" formControlName="statut" class="form-control" required>
            <option *ngFor="let s of statuts" [value]="s">{{ s }}</option>
          </select>
        </div>
        <div class="col-md-4 form-group">
          <label for="niveauEtude">Cycle d'étude *</label>
          <select id="niveauEtude" formControlName="niveauEtude" class="form-control" required>
            <option *ngFor="let n of niveaux" [value]="n">{{ n }}</option>
          </select>
        </div>
        <div class="col-md-4 form-group">
          <label for="anneeCycle">Niveau d'étude *</label>
          <select id="anneeCycle" formControlName="anneeCycle" class="form-control" required>
            <option *ngFor="let a of anneesDisponibles" [value]="a.value">{{ a.label }}</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="certificationProfessionnelle">Certification Professionnelle (RNCP/RS)</label>
        <input id="certificationProfessionnelle" type="text" formControlName="certificationProfessionnelle" class="form-control">
      </div>
    </fieldset>

    <!-- Section 2: Objectifs et Débouchés -->
    <fieldset class="form-section">
      <legend>Objectifs, Prérequis et Débouchés</legend>
      <div class="form-group">
        <label for="objectifs">Objectifs Pédagogiques</label>
        <textarea id="objectifs" formControlName="objectifs" class="form-control" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label for="prerequis">Prérequis</label>
        <textarea id="prerequis" formControlName="prerequis" class="form-control" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label for="debouches">Débouchés Professionnels</label>
        <textarea id="debouches" formControlName="debouches" class="form-control" rows="3"></textarea>
      </div>
    </fieldset>

    <!-- Section 3: Compétences (FormArray) -->
    <fieldset class="form-section">
      <legend>Compétences Visées (Approche par Compétences)</legend>
      <div formArrayName="competences">
        <div *ngFor="let competenceGroup of competences.controls; let i = index" [formGroupName]="i" class="nested-form-group">
          <h4>Compétence #{{ i + 1 }}
            <button type="button" (click)="supprimerCompetence(i)" class="btn btn-sm btn-danger float-right">Supprimer</button>
          </h4>
          <div class="row">
            <div class="col-md-6 form-group">
              <label>Libellé *</label>
              <input type="text" formControlName="libelle" class="form-control" required>
              <div *ngIf="competenceGroup.get('libelle')?.invalid && competenceGroup.get('libelle')?.touched" 
                   class="text-danger small">
                Le libellé est requis.
              </div>
            </div>
            <div class="col-md-6 form-group">
              <label>Niveau d'Acquisition Visé *</label>
              <select formControlName="niveauAcquisition" class="form-control" required>
                <option *ngFor="let n of niveauxAcquisition" [value]="n">{{ n }}</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Indicateurs d'Évaluation (Séparés par des virgules)</label>
            <textarea formControlName="indicateursEvaluation" class="form-control" rows="2"></textarea>
          </div>
        </div>
      </div>
      <button type="button" (click)="ajouterCompetence()" class="btn btn-secondary mt-2">Ajouter une Compétence</button>
    </fieldset>

    <!-- Section 4: Unités d'Enseignement (UE) / Modules (FormArray) -->
    <fieldset class="form-section">
      <legend>Unités d'Enseignement (UE) / Modules</legend>
      <div formArrayName="unitesEnseignement">
        <div *ngFor="let ueGroup of unitesEnseignement.controls; let j = index" [formGroupName]="j" class="nested-form-group ue-group">
          <h3>UE / Module #{{ j + 1 }}
            <button type="button" (click)="supprimerUniteEnseignement(j)" class="btn btn-sm btn-danger float-right">Supprimer</button>
          </h3>
          <div class="row">
            <div class="col-md-6 form-group">
              <label>Nom de l'UE *</label>
              <input type="text" formControlName="nom" class="form-control" required>
            </div>
            <div class="col-md-3 form-group">
              <label>Code *</label>
              <input type="text" formControlName="code" class="form-control" required>
            </div>
            <div class="col-md-3 form-group">
              <label>ECTS *</label>
              <input type="number" formControlName="ects" class="form-control" min="0" required>
            </div>
            <div class="col-md-3 form-group">
              <label>Semestre *</label>
              <input type="number" formControlName="semestre" class="form-control" min="1" required>
            </div>
          </div>
          <div class="form-group">
            <label>Description de l'UE</label>
            <textarea formControlName="description" class="form-control" rows="2"></textarea>
          </div>

          <!-- Volume Horaire Détaillé -->
          <div class="row">
            <div class="col-md-4 form-group">
              <label>Volume Horaire CM (Cours Magistraux) *</label>
              <input type="number" formControlName="volumeHoraireCours" class="form-control" min="0" required>
            </div>
            <div class="col-md-4 form-group">
              <label>Volume Horaire TD (Travaux Dirigés) *</label>
              <input type="number" formControlName="volumeHoraireTD" class="form-control" min="0" required>
            </div>
            <div class="col-md-4 form-group">
              <label>Volume Horaire TP (Travaux Pratiques) *</label>
              <input type="number" formControlName="volumeHoraireTP" class="form-control" min="0" required>
            </div>
          </div>

          <!-- Sélection des Éléments Constitutifs (Matières) -->
          <div class="form-group">
            <label>Éléments Constitutifs Rattachés (Matières)</label>
            <select formControlName="elementConstitutifIds" class="form-control" multiple size="4">
              <option *ngFor="let ec of tousLesElementsConstitutifs" [value]="ec.id">{{ ec.nom }} ({{ ec.code }})</option>
            </select>
            <small class="form-text text-muted">
              Sélectionnez les matières qui composent cette UE/Module (Ctrl+clic pour sélection multiple).
            </small>
          </div>
        </div>
      </div>
      <button type="button" (click)="ajouterUniteEnseignement()" class="btn btn-secondary mt-2">Ajouter une Unité d'Enseignement (UE)</button>
    </fieldset>

    <!-- Section 5: Modalités et Logistique -->
    <fieldset class="form-section">
      <legend>Modalités et Logistique</legend>
      <div class="row">
        <div class="col-md-4 form-group">
          <label for="modaliteEnseignement">Modalité d'Enseignement *</label>
          <select id="modaliteEnseignement" formControlName="modaliteEnseignement" class="form-control" required>
            <option *ngFor="let m of modalites" [value]="m">{{ m }}</option>
          </select>
        </div>
        <div class="col-md-4 form-group">
          <label for="duree">Durée (en années/semestres) *</label>
          <input id="duree" type="number" formControlName="duree" class="form-control" min="1" required>
        </div>
        <div class="col-md-4 form-group">
          <label for="capacite">Capacité d'Accueil</label>
          <input id="capacite" type="number" formControlName="capacite" class="form-control" min="1">
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 form-group">
          <label for="dateDebut">Date de Début</label>
          <input id="dateDebut" type="date" formControlName="dateDebut" class="form-control">
        </div>
        <div class="col-md-6 form-group">
          <label for="dateFin">Date de Fin</label>
          <input id="dateFin" type="date" formControlName="dateFin" class="form-control">
        </div>
      </div>

      <div class="form-group">
        <label for="evaluationModalites">Modalités d'Évaluation</label>
        <textarea id="evaluationModalites" formControlName="evaluationModalites" class="form-control" rows="3"></textarea>
      </div>
    </fieldset>

    <!-- Boutons d'action -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary" [disabled]="formationForm.invalid">
        {{ editingFormationId ? 'Mettre à jour' : 'Créer la Formation' }}
      </button>
      <button type="button" (click)="resetForm()" class="btn btn-secondary">Annuler / Nouveau</button>
    </div>
  </form>

  <hr>

  <!-- Liste des Formations Existantes (Simplifiée) -->
  <div class="formations-list">
    <h2>Formations Existantes</h2>
    <div *ngIf="isLoading" class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Chargement...</span>
      </div>
      <p class="mt-2">Chargement des formations...</p>
    </div>
    
    <table class="table table-striped table-hover" *ngIf="!isLoading && formations.length > 0">
      <thead class="thead-dark">
        <tr>
          <th>Nom</th>
          <th>Code</th>
          <th>Établissement</th>
          <th>UFR</th>
          <th>Niveau</th>
          <th>Statut</th>
          <th>ECTS</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let f of formations">
          <td><strong>{{ f.nom }}</strong></td>
          <td><code>{{ f.code }}</code></td>
          <td>{{ f.etablissement?.nom || 'N/A' }}</td>
          <td>{{ f.uefr?.nom || 'N/A' }}</td>
          <td>{{ f.niveauEtude }} - {{ f.anneeCycle }}</td>
          <td>
            <span class="badge" [ngClass]="{
              'badge-success': f.statut === 'ACTIF',
              'badge-secondary': f.statut === 'ARCHIVE',
              'badge-warning': f.statut === 'EN_PREPARATION',
              'badge-info': f.statut === 'EN_VALIDATION'
            }">
              {{ f.statut }}
            </span>
          </td>
          <td>{{ f.ectsTotal || 0 }}</td>
          <td>
            <button (click)="editerFormation(f)" class="btn btn-sm btn-info mr-2">
              <i class="fas fa-edit"></i> Éditer
            </button>
            <button (click)="supprimerFormation(f.id)" class="btn btn-sm btn-danger">
              <i class="fas fa-trash"></i> Supprimer
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    
    <div *ngIf="!isLoading && formations.length === 0" class="alert alert-warning">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      Aucune formation trouvée. Cliquez sur "Créer la Formation" pour en ajouter une.
    </div>
  </div>
</div>
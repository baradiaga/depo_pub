<div class="container-fluid py-3">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col">
      <h2 class="mb-0">
        <i class="bi bi-building me-2"></i>Gestion des Établissements
      </h2>
      <p class="text-muted">Gérez les établissements de votre organisation</p>
    </div>
    <div class="col-auto">
      <div class="btn-group">
        <button class="btn btn-outline-info" (click)="toggleSearchMode()" 
                [title]="useServerSideSearch ? 'Recherche serveur activée' : 'Recherche client activée'"
                [disabled]="isLoading">
          <i class="bi" [class.bi-server]="useServerSideSearch" [class.bi-pc]="!useServerSideSearch"></i>
          {{ useServerSideSearch ? 'Serveur' : 'Client' }}
        </button>
        <button class="btn btn-outline-success" (click)="exportToCSV()" title="Exporter en CSV"
                [disabled]="isLoading || filteredEtablissements.length === 0">
          <i class="bi bi-download"></i> Exporter
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="alert alert-info d-flex align-items-center" *ngIf="isLoading && !isEditMode">
    <div class="spinner-border spinner-border-sm me-3" role="status"></div>
    <span class="fw-medium">Chargement des données...</span>
  </div>

  <!-- Filter Card -->
  <div class="card shadow-sm mb-4" *ngIf="!isLoading">
    <div class="card-header bg-white border-bottom-0 pb-0">
      <h5 class="card-title mb-0">
        <i class="bi bi-funnel me-2"></i>Filtres et Recherche
      </h5>
    </div>
    <div class="card-body pt-3">
      <form [formGroup]="filterForm">
        <div class="row g-3">
          <!-- Search Input -->
          <div class="col-lg-8">
            <label for="search" class="form-label fw-medium">Recherche rapide</label>
            <div class="input-group">
              <span class="input-group-text bg-light">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" class="form-control" id="search" formControlName="search"
                     placeholder="Rechercher par nom, sigle, adresse ou contact..."
                     [disabled]="isLoading">
              <button class="btn btn-outline-secondary" type="button" (click)="resetFilters()" 
                      [disabled]="!filterForm.dirty || isLoading">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
            <div class="form-text">Recherche en temps réel</div>
          </div>

          <!-- Items per Page -->
          <div class="col-lg-4">
            <label for="itemsPerPage" class="form-label fw-medium">Éléments par page</label>
            <select class="form-select" id="itemsPerPage" 
                    [ngModel]="itemsPerPage" [ngModelOptions]="{standalone: true}"
                    (change)="changeItemsPerPage($event)"
                    [disabled]="isLoading">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <!-- Sort By -->
          <div class="col-lg-4">
            <label for="sortBy" class="form-label fw-medium">Trier par</label>
            <select class="form-select" id="sortBy" formControlName="sortBy"
                    [disabled]="isLoading">
              <option value="nom">Nom</option>
              <option value="sigle">Sigle</option>
              <option value="adresse">Adresse</option>
              <option value="contact">Contact</option>
            </select>
          </div>

          <!-- Sort Order -->
          <div class="col-lg-4">
            <label for="sortOrder" class="form-label fw-medium">Ordre de tri</label>
            <select class="form-select" id="sortOrder" formControlName="sortOrder"
                    [disabled]="isLoading">
              <option value="asc">Croissant (A → Z)</option>
              <option value="desc">Décroissant (Z → A)</option>
            </select>
          </div>

          <!-- Actions -->
          <div class="col-lg-4 d-flex align-items-end">
            <div class="d-flex gap-2 w-100">
              <button type="button" class="btn btn-primary flex-fill" (click)="applyFilters()"
                      [disabled]="useServerSideSearch || isLoading">
                <i class="bi bi-funnel me-1"></i> Appliquer
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="resetFilters()"
                      [disabled]="isLoading">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Stats Card -->
  <div class="row mb-4" *ngIf="!isLoading">
    <div class="col-md-4">
      <div class="card bg-primary text-white shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">Total</h6>
              <h2 class="mb-0">{{ etablissements.length }}</h2>
              <small>Tous établissements</small>
            </div>
            <i class="bi bi-building display-6 opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-success text-white shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">Filtrés</h6>
              <h2 class="mb-0">{{ filteredEtablissements.length }}</h2>
              <small>Avec filtres appliqués</small>
            </div>
            <i class="bi bi-funnel display-6 opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-info text-white shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">Page actuelle</h6>
              <h2 class="mb-0">{{ paginatedEtablissements.length }}</h2>
              <small>Éléments affichés</small>
            </div>
            <i class="bi bi-file-text display-6 opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Card -->
  <div class="card shadow-sm mb-4" id="form-etablissement">
    <div class="card-header" [class.bg-warning]="isEditMode" [class.bg-primary]="!isEditMode">
      <h5 class="card-title mb-0 text-white">
        <i class="bi" [class.bi-pencil-square]="isEditMode" [class.bi-plus-circle]="!isEditMode"></i>
        {{ isEditMode ? 'Modifier l\'Établissement' : 'Nouvel Établissement' }}
      </h5>
    </div>
    <div class="card-body">
      <form [formGroup]="etablissementForm" (ngSubmit)="saveEtablissement()" novalidate>
        <div class="row g-3">
          <!-- Nom -->
          <div class="col-md-6">
            <label for="nom" class="form-label fw-medium">Nom <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="nom" formControlName="nom"
                   [class.is-invalid]="etablissementForm.get('nom')?.invalid && etablissementForm.get('nom')?.touched"
                   placeholder="Ex: Université de Technologie"
                   [disabled]="isLoading">
            <div class="invalid-feedback" *ngIf="etablissementForm.get('nom')?.hasError('required')">
              Le nom est obligatoire
            </div>
            <div class="invalid-feedback" *ngIf="etablissementForm.get('nom')?.hasError('minlength')">
              Minimum 2 caractères
            </div>
            <div class="invalid-feedback" *ngIf="etablissementForm.get('nom')?.hasError('maxlength')">
              Maximum 100 caractères
            </div>
          </div>

          <!-- Sigle -->
          <div class="col-md-6">
            <label for="sigle" class="form-label fw-medium">Sigle <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="sigle" formControlName="sigle"
                   [class.is-invalid]="etablissementForm.get('sigle')?.invalid && etablissementForm.get('sigle')?.touched"
                   placeholder="Ex: UTECH"
                   [disabled]="isLoading">
            <div class="invalid-feedback" *ngIf="etablissementForm.get('sigle')?.hasError('required')">
              Le sigle est obligatoire
            </div>
            <div class="invalid-feedback" *ngIf="etablissementForm.get('sigle')?.hasError('minlength')">
              Minimum 2 caractères
            </div>
            <div class="invalid-feedback" *ngIf="etablissementForm.get('sigle')?.hasError('maxlength')">
              Maximum 20 caractères
            </div>
          </div>

          <!-- Adresse -->
          <div class="col-12">
            <label for="adresse" class="form-label fw-medium">Adresse <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="adresse" formControlName="adresse"
                   [class.is-invalid]="etablissementForm.get('adresse')?.invalid && etablissementForm.get('adresse')?.touched"
                   placeholder="Adresse complète de l'établissement"
                   [disabled]="isLoading">
            <div class="invalid-feedback" *ngIf="etablissementForm.get('adresse')?.hasError('required')">
              L'adresse est obligatoire
            </div>
            <div class="invalid-feedback" *ngIf="etablissementForm.get('adresse')?.hasError('maxlength')">
              Maximum 200 caractères
            </div>
          </div>

          <!-- Contact -->
          <div class="col-md-6">
            <label for="contact" class="form-label fw-medium">Contact <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="contact" formControlName="contact"
                   [class.is-invalid]="etablissementForm.get('contact')?.invalid && etablissementForm.get('contact')?.touched"
                   placeholder="Email, téléphone ou site web"
                   [disabled]="isLoading">
            <div class="invalid-feedback" *ngIf="etablissementForm.get('contact')?.hasError('required')">
              Le contact est obligatoire
            </div>
            <div class="invalid-feedback" *ngIf="etablissementForm.get('contact')?.hasError('maxlength')">
              Maximum 100 caractères
            </div>
          </div>

          <!-- Logo (Fichier) -->
          <div class="col-md-6">
            <label for="logo" class="form-label fw-medium">Logo</label>
            <input type="file" class="form-control" id="logo" 
                   (change)="onLogoSelected($event)"
                   accept=".jpg,.jpeg,.png,.gif,.svg,.webp"
                   [disabled]="isLoading">
            
            <!-- Statut du logo -->
            <div class="mt-2">
              <!-- Nouveau fichier sélectionné -->
              <div *ngIf="selectedLogoFile && !isEditMode" class="alert alert-success py-1 mb-2">
                <small>
                  <i class="bi bi-check-circle-fill me-1"></i> 
                  Nouveau logo sélectionné : <strong>{{selectedLogoFile.name}}</strong>
                  <span *ngIf="selectedLogoFile.size !== undefined">({{getFileSize(selectedLogoFile.size)}})</span>
                </small>
              </div>
              
              <!-- Remplacement en mode édition -->
              <div *ngIf="selectedLogoFile && isEditMode" class="alert alert-warning py-1 mb-2">
                <small>
                  <i class="bi bi-exclamation-triangle-fill me-1"></i> 
                  Logo à remplacer : <strong>{{selectedLogoFile.name}}</strong>
                  <span *ngIf="selectedLogoFile.size !== undefined">({{getFileSize(selectedLogoFile.size)}})</span>
                </small>
              </div>
              
              <!-- Logo existant en mode édition -->
              <div *ngIf="isEditMode && currentLogoName && !selectedLogoFile" class="alert alert-info py-1 mb-2">
                <small>
                  <i class="bi bi-info-circle-fill me-1"></i> 
                  Logo actuel : <strong>{{currentLogoName}}</strong>
                  <button type="button" class="btn btn-sm btn-outline-danger ms-2 py-0" 
                          (click)="removeCurrentLogo()" [disabled]="isLoading">
                    <i class="bi bi-trash"></i> Supprimer
                  </button>
                </small>
              </div>
            </div>
            
            <!-- Aperçu du logo -->
            <div *ngIf="logoPreviewUrl" class="mt-2 text-center">
              <div class="border rounded p-2 bg-light">
                <h6 class="text-muted mb-2"><i class="bi bi-eye me-1"></i>Aperçu</h6>
                <img [src]="logoPreviewUrl" class="img-thumbnail" 
                     style="max-height: 100px; max-width: 150px;"
                     alt="Aperçu du logo">
                <p class="text-muted mt-2 mb-0 small">Prévisualisation</p>
              </div>
            </div>
            
            <div class="form-text">
              Formats acceptés : JPG, PNG, GIF, SVG, WebP - Taille max : 2MB
            </div>
          </div>

          <!-- Lien (Site Web) -->
          <div class="col-12">
            <label for="lien" class="form-label fw-medium">Site Web (URL)</label>
            <input type="text" class="form-control" id="lien" formControlName="lien"
                   [class.is-invalid]="etablissementForm.get('lien')?.invalid && etablissementForm.get('lien')?.touched"
                   placeholder="https://www.example.com"
                   [disabled]="isLoading">
            <div class="invalid-feedback" *ngIf="etablissementForm.get('lien')?.hasError('pattern')">
              Format d'URL invalide. Doit commencer par http:// ou https://
            </div>
            <div class="form-text">URL complète du site web officiel</div>
          </div>

          <!-- Form Actions -->
          <div class="col-12">
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary" 
                      [disabled]="etablissementForm.invalid || isLoading">
                <i class="bi" [class.bi-check-circle]="!isEditMode" [class.bi-arrow-repeat]="isEditMode"></i>
                {{ isEditMode ? 'Mettre à jour' : 'Créer' }}
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm ms-2"></span>
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="resetForm()" 
                      *ngIf="isEditMode" [disabled]="isLoading">
                <i class="bi bi-x-circle"></i> Annuler
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="resetForm()" 
                      *ngIf="!isEditMode" [disabled]="isLoading">
                <i class="bi bi-eraser"></i> Effacer
              </button>
            </div>
            
            <!-- Validation summary -->
            <div class="alert alert-danger mt-3" 
                 *ngIf="etablissementForm.invalid && (etablissementForm.touched || etablissementForm.dirty)">
              <h6 class="alert-heading">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>Erreurs de validation
              </h6>
              <ul class="mb-0">
                <li *ngIf="etablissementForm.get('nom')?.hasError('required')">Le nom est obligatoire</li>
                <li *ngIf="etablissementForm.get('nom')?.hasError('minlength')">Le nom doit avoir au moins 2 caractères</li>
                <li *ngIf="etablissementForm.get('nom')?.hasError('maxlength')">Le nom ne doit pas dépasser 100 caractères</li>
                <li *ngIf="etablissementForm.get('sigle')?.hasError('required')">Le sigle est obligatoire</li>
                <li *ngIf="etablissementForm.get('sigle')?.hasError('minlength')">Le sigle doit avoir au moins 2 caractères</li>
                <li *ngIf="etablissementForm.get('sigle')?.hasError('maxlength')">Le sigle ne doit pas dépasser 20 caractères</li>
                <li *ngIf="etablissementForm.get('adresse')?.hasError('required')">L'adresse est obligatoire</li>
                <li *ngIf="etablissementForm.get('adresse')?.hasError('maxlength')">L'adresse ne doit pas dépasser 200 caractères</li>
                <li *ngIf="etablissementForm.get('contact')?.hasError('required')">Le contact est obligatoire</li>
                <li *ngIf="etablissementForm.get('contact')?.hasError('maxlength')">Le contact ne doit pas dépasser 100 caractères</li>
                <li *ngIf="etablissementForm.get('lien')?.hasError('pattern')">Format d'URL de site web invalide</li>
              </ul>
            </div>
            
            <!-- Information sur le logo -->
            <div class="alert alert-info mt-3" *ngIf="selectedLogoFile">
              <h6 class="alert-heading">
                <i class="bi bi-info-circle-fill me-1"></i>Information sur le logo
              </h6>
              <p class="mb-0 small">
                Le logo <strong>{{selectedLogoFile.name}}</strong> sera uploadé sur le serveur lors de la sauvegarde.
                <span *ngIf="selectedLogoFile.size !== undefined">
                  Taille : {{getFileSize(selectedLogoFile.size)}}.
                </span>
              </p>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Table Card -->
  <div class="card shadow-sm" id="etablissements-table">
    <div class="card-header bg-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="bi bi-list-columns me-2"></i>Liste des Établissements
        </h5>
        <span class="badge rounded-pill bg-dark">
          {{ currentPage }}/{{ totalPages }}
        </span>
      </div>
    </div>
    <div class="card-body">
      <!-- No Results -->
      <div class="text-center py-5" *ngIf="filteredEtablissements.length === 0 && !isLoading">
        <i class="bi bi-search display-1 text-muted mb-3"></i>
        <h5 class="text-muted">Aucun établissement trouvé</h5>
        <p class="text-muted mb-4">Essayez de modifier vos critères de recherche</p>
        <button class="btn btn-outline-primary" (click)="resetFilters()" [disabled]="isLoading">
          <i class="bi bi-arrow-clockwise me-1"></i> Réinitialiser les filtres
        </button>
      </div>

      <!-- Table -->
      <div class="table-responsive" *ngIf="filteredEtablissements.length > 0">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th width="50">ID</th>
              <th>
                <a href="javascript:void(0)" class="text-decoration-none text-dark" 
                   (click)="filterForm.get('sortBy')?.setValue('nom'); applyFilters()"
                   [class.text-muted]="isLoading">
                  Nom
                  <i class="bi ms-1" 
                     [class.bi-sort-down]="filterForm.get('sortBy')?.value === 'nom' && filterForm.get('sortOrder')?.value === 'asc'"
                     [class.bi-sort-up]="filterForm.get('sortBy')?.value === 'nom' && filterForm.get('sortOrder')?.value === 'desc'"></i>
                </a>
              </th>
              <th>
                <a href="javascript:void(0)" class="text-decoration-none text-dark"
                   (click)="filterForm.get('sortBy')?.setValue('sigle'); applyFilters()"
                   [class.text-muted]="isLoading">
                  Sigle
                  <i class="bi ms-1"
                     [class.bi-sort-down]="filterForm.get('sortBy')?.value === 'sigle' && filterForm.get('sortOrder')?.value === 'asc'"
                     [class.bi-sort-up]="filterForm.get('sortBy')?.value === 'sigle' && filterForm.get('sortOrder')?.value === 'desc'"></i>
                </a>
              </th>
              <th>Adresse</th>
              <th>Contact</th>
              <th width="150" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let etab of paginatedEtablissements">
              <td>
                <span class="badge bg-secondary">#{{ etab.id }}</span>
              </td>
              <td class="fw-medium">
                {{ etab.nom }}
                <div *ngIf="etab.logo" class="mt-1">
                  <span class="badge bg-success text-white small">
                    <i class="bi bi-image me-1"></i>Logo
                  </span>
                </div>
              </td>
              <td>
                <span class="badge bg-info text-dark">{{ etab.sigle }}</span>
              </td>
              <td>
                <small class="text-muted">{{ etab.adresse }}</small>
              </td>
              <td>
                <small>{{ etab.contact }}</small>
                <div *ngIf="etab.lien" class="mt-1">
                  <a [href]="etab.lien" target="_blank" 
                     class="badge bg-light text-dark border small text-decoration-none">
                    <i class="bi bi-link-45deg me-1"></i>Site
                  </a>
                </div>
              </td>
              <td>
                <div class="d-flex justify-content-center gap-1">
                  <button class="btn btn-sm btn-outline-warning" (click)="editEtablissement(etab)" 
                          title="Modifier" [disabled]="isLoading">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" (click)="deleteEtablissement(etab.id!)"
                          title="Supprimer" [disabled]="isLoading">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-4" *ngIf="filteredEtablissements.length > 0">
        <div class="text-muted">
          Affichage de <strong>{{ (currentPage - 1) * itemsPerPage + 1 }}</strong> 
          à <strong>{{ Math.min(currentPage * itemsPerPage, totalItems) }}</strong> 
          sur <strong>{{ totalItems }}</strong> éléments
        </div>
        
        <nav aria-label="Navigation des pages">
          <ul class="pagination mb-0">
            <!-- First & Previous -->
            <li class="page-item" [class.disabled]="currentPage === 1 || isLoading">
              <a class="page-link" (click)="currentPage !== 1 && !isLoading ? changePage(1) : null" 
                 [class.disabled]="currentPage === 1 || isLoading"
                 [class.pointer-events-none]="currentPage === 1 || isLoading">
                <i class="bi bi-chevron-double-left"></i>
              </a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === 1 || isLoading">
              <a class="page-link" (click)="currentPage !== 1 && !isLoading ? changePage(currentPage - 1) : null" 
                 [class.disabled]="currentPage === 1 || isLoading"
                 [class.pointer-events-none]="currentPage === 1 || isLoading">
                <i class="bi bi-chevron-left"></i>
              </a>
            </li>
            
            <!-- Page Numbers -->
            <li class="page-item" *ngFor="let page of getPageNumbers()" 
                [class.active]="page === currentPage"
                [class.disabled]="isLoading">
              <a class="page-link" (click)="!isLoading ? changePage(page) : null" 
                 [class.disabled]="isLoading"
                 [class.pointer-events-none]="isLoading">{{ page }}</a>
            </li>
            
            <!-- Next & Last -->
            <li class="page-item" [class.disabled]="currentPage === totalPages || isLoading">
              <a class="page-link" (click)="currentPage !== totalPages && !isLoading ? changePage(currentPage + 1) : null" 
                 [class.disabled]="currentPage === totalPages || isLoading"
                 [class.pointer-events-none]="currentPage === totalPages || isLoading">
                <i class="bi bi-chevron-right"></i>
              </a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === totalPages || isLoading">
              <a class="page-link" (click)="currentPage !== totalPages && !isLoading ? changePage(totalPages) : null" 
                 [class.disabled]="currentPage === totalPages || isLoading"
                 [class.pointer-events-none]="currentPage === totalPages || isLoading">
                <i class="bi bi-chevron-double-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
<div class="container mt-4">
  <h2>Gestion de la Banque de Questions</h2>

  <!-- Formulaire de Création/Édition -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      {{ isEditMode ? 'Éditer la Question (ID: ' + questionIdToEdit + ')' : 'Ajouter une Nouvelle Question' }}
    </div>

    <div class="card-body">
      <form (ngSubmit)="sauvegarderQuestion()">

        <!-- MATIÈRE + CHAPITRE -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="matiere">Matière</label>
            <select id="matiere" class="form-control"
        (change)="onMatiereChange($event)">
  <option [ngValue]="null">-- Sélectionner une matière --</option>
  <option *ngFor="let matiere of mesMatieres" [ngValue]="matiere.id">{{ matiere.nom }}</option>
</select>
          </div>

          <div class="col-md-6 mb-3">
            <label for="chapitre">Chapitre</label>
            <select id="chapitre" class="form-control"
        [(ngModel)]="questionForm.chapitreId" name="chapitreId" required>
  <option [ngValue]="null">-- Sélectionner un chapitre --</option>
  <option *ngFor="let chapitre of chapitresDisponibles" [ngValue]="chapitre.id">
    {{ chapitre.nom }}
  </option>
</select>
          </div>
        </div>

        <!-- ENONCE -->
        <div class="mb-3">
          <label for="enonce">Énoncé de la Question</label>
          <textarea id="enonce" class="form-control"
                    [(ngModel)]="questionForm.enonce" name="enonce"
                    rows="3" required></textarea>
        </div>

        <!-- TYPE DE QUESTION + POINTS + DIFFICULTÉ -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="type">Type de Question</label>
            <select id="type" class="form-control"
                    [(ngModel)]="questionForm.typeQuestion"
                    name="typeQuestion"
                    (change)="onTypeQuestionChange()">
              <option *ngFor="let type of typesQuestion" [value]="type">{{ type }}</option>
            </select>
          </div>

          <div class="col-md-4 mb-3">
            <label for="points">Points</label>
            <input id="points" type="number" class="form-control"
                   [(ngModel)]="questionForm.points" name="points"
                   required min="1">
          </div>

          <div class="col-md-4 mb-3">
            <label for="difficulte">Difficulté</label>
            <select id="difficulte" class="form-control"
                    [(ngModel)]="questionForm.difficulte" name="difficulte">
              <option *ngFor="let diff of difficultes" [value]="diff">{{ diff }}</option>
            </select>
          </div>
        </div>

        <!-- RÉPONSES -->
        <h5 class="mt-3">Réponses</h5>

        <div *ngFor="let reponse of questionForm.reponses; let i = index" class="input-group mb-2">
          <div class="input-group-text">
            <input type="checkbox"
                   [checked]="reponse.correcte"
                   (change)="marquerReponseCorrecte(i)"
                   [disabled]="questionForm.typeQuestion === 'TEXTE_LIBRE'">
          </div>

          <input type="text" class="form-control"
                 [(ngModel)]="reponse.texte"
                 [name]="'reponseText' + i"
                 placeholder="Texte de la réponse" required>

          <button type="button" class="btn btn-outline-danger" (click)="supprimerReponse(i)">X</button>
        </div>

        <button type="button"
                class="btn btn-sm btn-outline-secondary mt-2"
                (click)="ajouterReponse()"
                *ngIf="questionForm.typeQuestion !== 'TEXTE_LIBRE'">
          Ajouter une Réponse
        </button>

        <!-- TAGS -->
        <h5 class="mt-3">Tags (séparés par des virgules)</h5>
        <input type="text" class="form-control"
               [ngModel]="questionForm.tags.join(', ')"
               (ngModelChange)="mettreAJourTags($event)"
               name="tagsInput"
               placeholder="Ex: Algèbre, Fonction, Niveau 1">

        <!-- BOUTONS -->
        <div class="mt-4">
          <button type="submit" class="btn btn-success" [disabled]="isSaving">
            <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
            {{ isEditMode ? 'Mettre à Jour' : 'Créer la Question' }}
          </button>

          <button type="button" class="btn btn-secondary ms-2" (click)="reinitialiserFormulaire()">
            Annuler / Nouveau
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- LISTE DES QUESTIONS -->
  <div class="card">
    <div class="card-header bg-info text-white">
      Questions de la Banque ({{ questions.length }})
    </div>

    <div class="card-body">

      <div *ngIf="isLoadingList" class="text-center">Chargement...</div>

      <ul class="list-group">
        <li *ngFor="let q of questions"
            class="list-group-item d-flex justify-content-between align-items-center">

          <div>
            <strong>{{ q.enonce | slice:0:100 }}...</strong>
            <small class="text-muted d-block">
              Chapitre: {{ q.chapitreNom }} |
              Type: {{ q.typeQuestion }} |
              Note: {{ q.noteQualite | number:'1.1-1' }}
            </small>

            <span *ngFor="let tag of q.tags" class="badge bg-secondary me-1">{{ tag }}</span>
          </div>

          <div>
            <button class="btn btn-sm btn-outline-primary me-2" (click)="editerQuestion(q)">
              Éditer
            </button>

            <button class="btn btn-sm btn-outline-danger"
                    (click)="supprimerQuestion(q.id, q.enonce)">
              Supprimer
            </button>
          </div>

        </li>
      </ul>

    </div>
  </div>
</div>

<!-- Fichier : deroulement-test.component.html (Version Finale Corrigée) -->

<div class="container mt-4">
  <div class="card shadow">
    <div class="card-header bg-success text-white">
      <h3 class="mb-0">Test de Connaissance</h3>
    </div>
    <div class="card-body" [class.submitting]="isSubmitting">
      <!-- Spinner de chargement initial -->
      <div *ngIf="isLoading" class="text-center p-5">
        <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="mt-3">Préparation de votre test...</p>
      </div>

      <!-- Contenu du test -->
      <div *ngIf="!isLoading && questions.length > 0">
        <p class="lead">Répondez aux questions suivantes. Le temps n'est pas limité pour ce test de diagnostic.</p>
        <hr>

        <div *ngFor="let question of questions; let i = index" class="mb-4 p-3 border rounded bg-light">
          <h5 class="fw-bold">Question {{ i + 1 }}</h5>
          <p class="fs-5" [innerHTML]="question.enonce"></p>

          <div [ngSwitch]="question.typeQuestion">

            <!-- QCU : Boutons Radio -->
            <div *ngSwitchCase="'QCU'" class="list-group">
              <label *ngFor="let option of question.options" class="list-group-item list-group-item-action">
                <input class="form-check-input me-2" type="radio" [name]="'question-' + question.id" [value]="option.id" [(ngModel)]="reponsesUtilisateur[question.id]">
                {{ option.texte }}
              </label>
            </div>

            <!-- QCM : Cases à cocher -->
            <div *ngSwitchCase="'QCM'" class="list-group">
              <!-- LE BLOC FAUTIF A ÉTÉ SUPPRIMÉ D'ICI -->
              <label *ngFor="let option of question.options" class="list-group-item list-group-item-action">
                <input class="form-check-input me-2" type="checkbox" [name]="'option-' + option.id" [(ngModel)]="reponsesUtilisateur[question.id][option.id]">
                {{ option.texte }}
              </label>
            </div>

            <!-- VRAI_FAUX : Boutons Radio -->
            <div *ngSwitchCase="'VRAI_FAUX'" class="list-group">
              <label class="list-group-item list-group-item-action">
                <input class="form-check-input me-2" type="radio" [name]="'question-' + question.id" [value]="true" [(ngModel)]="reponsesUtilisateur[question.id]"> Vrai
              </label>
              <label class="list-group-item list-group-item-action">
                <input class="form-check-input me-2" type="radio" [name]="'question-' + question.id" [value]="false" [(ngModel)]="reponsesUtilisateur[question.id]"> Faux
              </label>
            </div>

            <!-- TEXTE_LIBRE : Zone de texte -->
            <div *ngSwitchCase="'TEXTE_LIBRE'">
              <textarea class="form-control" rows="3" placeholder="Votre réponse..." [(ngModel)]="reponsesUtilisateur[question.id]"></textarea>
            </div>
          </div>
        </div>

        <div class="d-grid mt-4">
          <button class="btn btn-primary btn-lg" (click)="soumettreTest()" [disabled]="isSubmitting">
            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i *ngIf="!isSubmitting" class="bi bi-check2-circle me-2"></i>
            {{ isSubmitting ? 'Soumission en cours...' : 'Soumettre mes réponses' }}
          </button>
        </div>
      </div>

      <!-- Message si le test est vide -->
      <div *ngIf="!isLoading && questions.length === 0" class="alert alert-warning text-center">
        <h4><i class="bi bi-exclamation-triangle"></i> Oups !</h4>
        <p>Nous n'avons pas pu trouver de questions pour cette matière pour le moment.</p>
      </div>
    </div>
  </div>
</div>

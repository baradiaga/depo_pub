<div class="container mt-5">
  <!-- Indicateur de chargement -->
  <div *ngIf="isLoading" class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p>Chargement du test en cours...</p>
  </div>

  <!-- Contenu du test (affiché une fois le chargement terminé) -->
  <div *ngIf="!isLoading && isTestMode && questions.length > 0">
    <div class="card shadow-sm">
      <div class="card-header">
        <h3>Test du Chapitre</h3>
        <p class="text-muted">Page {{ page }} sur {{ totalPages }}</p>
      </div>
      <div class="card-body">
        <!-- Boucle sur les questions de la page actuelle -->
        <div *ngFor="let q of displayedQuestions; let i = index" class="mb-4 border-bottom pb-3">
          <p><strong>Question {{ (page - 1) * pageSize + i + 1 }}:</strong> {{ q.enonce }}</p>
          
          <!-- Affichage des options en fonction du type de question -->
          <div [ngSwitch]="q.type">
            
            <!-- Cas QCU (Question à Choix Unique) -->
            <div *ngSwitchCase="'QCU'">
              <div *ngFor="let reponse of q.reponses" class="form-check">
                <input class="form-check-input" type="radio" [name]="'question-' + q.id" [id]="'reponse-' + reponse.id" (change)="choisirReponse(q.id, reponse.id)">
                <label class="form-check-label" [for]="'reponse-' + reponse.id">{{ reponse.texte }}</label>
              </div>
            </div>

            <!-- Cas QCM (Question à Choix Multiples) -->
            <div *ngSwitchCase="'QCM'">
              <div *ngFor="let reponse of q.reponses" class="form-check">
                <input class="form-check-input" type="checkbox" [id]="'reponse-' + reponse.id" (change)="choisirReponseMultiple(q.id, reponse.id, $event)">
                <label class="form-check-label" [for]="'reponse-' + reponse.id">{{ reponse.texte }}</label>
              </div>
            </div>

            <!-- Cas Vrai/Faux -->
            <div *ngSwitchCase="'VRAI_FAUX'">
              <div class="form-check">
                <input class="form-check-input" type="radio" [name]="'question-' + q.id" [id]="'vrai-' + q.id" (change)="choisirReponseVraiFaux(q.id, true)">
                <label class="form-check-label" [for]="'vrai-' + q.id">Vrai</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" [name]="'question-' + q.id" [id]="'faux-' + q.id" (change)="choisirReponseVraiFaux(q.id, false)">
                <label class="form-check-label" [for]="'faux-' + q.id">Faux</label>
              </div>
            </div>

            <!-- Cas Texte Libre -->
            <div *ngSwitchCase="'TEXTE_LIBRE'">
              <textarea class="form-control" rows="3" (blur)="saisirReponseTexte(q.id, $event)"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Pied de page avec la pagination et le bouton de validation -->
      <div class="card-footer d-flex justify-content-between align-items-center">
        <button class="btn btn-secondary" (click)="precedent()" [disabled]="page <= 1">Précédent</button>
        
        <!-- Le bouton "Valider" n'apparaît que sur la dernière page -->
        <button *ngIf="page === totalPages" class="btn btn-success" (click)="validerTest()" [disabled]="isSubmitting">
          <span *ngIf="!isSubmitting">Valider le Test</span>
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span *ngIf="isSubmitting"> Soumission...</span>
        </button>

        <button class="btn btn-primary" (click)="suivant()" [disabled]="page >= totalPages">Suivant</button>
      </div>
    </div>
  </div>

  <!-- Message si aucune question n'est trouvée -->
  <div *ngIf="!isLoading && isTestMode && questions.length === 0" class="alert alert-info text-center">
    <p>Aucune question n'est disponible pour ce test pour le moment.</p>
  </div>

  <!-- Nouvelle interface de sélection (Dashboard) -->
  <div *ngIf="!isLoading && !isTestMode" class="row">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">1. Matières Inscrites</h5>
        </div>
        <div class="list-group list-group-flush">
          <a *ngFor="let matiere of matieres" 
             href="#" 
             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
             [class.active]="matiereSelectionnee?.id === matiere.id"
             (click)="selectionnerMatiere(matiere)">
            {{ matiere.nom }}
            <span class="badge bg-secondary">{{ matiere.statutInscription }}</span>
          </a>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm" *ngIf="matiereSelectionnee">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">2. Chapitres de {{ matiereSelectionnee.nom }}</h5>
        </div>
        <div class="list-group list-group-flush">
          <a *ngFor="let chapitre of matiereSelectionnee.chapitres" 
             href="#" 
             class="list-group-item list-group-item-action"
             [class.active]="chapitreSelectionne?.id === chapitre.id"
             (click)="selectionnerChapitre(chapitre)">
            {{ chapitre.nom }} (Niveau {{ chapitre.niveau }})
          </a>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm" *ngIf="chapitreSelectionne">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">3. Tests du Chapitre {{ chapitreSelectionne.nom }}</h5>
        </div>
        <div class="list-group list-group-flush">
          <div *ngIf="chapitreSelectionne.tests.length === 0" class="list-group-item text-muted">
            Aucun test disponible pour ce chapitre.
          </div>
          <a *ngFor="let test of chapitreSelectionne.tests" 
             href="#" 
             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
             (click)="selectionnerTest(test)">
            <div>
              <strong>{{ test.titre }}</strong>
              <p class="mb-0 text-muted small">Meilleur score: {{ test.meilleurScore | number:'1.0-2' }}%</p>
            </div>
            <i class="fas fa-play-circle fa-lg text-success"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
